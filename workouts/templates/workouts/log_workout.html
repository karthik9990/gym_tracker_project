{% extends 'workouts/base.html' %}

{% block title %}Log Workout - {{ view_date|date:"Y-m-d" }}{% endblock %}

{% block content %}
<div class="container mt-4">
    {# Form to select/change the date being logged #}
    <form method="POST" action="{% url 'workouts:log_workout_date' date_str=view_date_str %}" class="mb-3">
         {% csrf_token %}
         <input type="hidden" name="action" value="change_date">
         <div class="row g-2 align-items-center">
             <div class="col-auto">
                <label for="selected_date" class="col-form-label"><strong>Logging Workout for Date:</strong></label>
             </div>
             <div class="col-auto">
                {# Use HTML5 date input with max attribute set from view context #}
                <input type="date" id="selected_date" name="selected_date"
                       class="form-control" value="{{ view_date_str }}"
                       max="{{ today_date_str }}" {# Use variable passed from view #}
                       required>
             </div>
             <div class="col-auto">
                <button type="submit" class="btn btn-secondary btn-sm">Go to Date</button>
             </div>
         </div>
    </form>

    <hr>

    <h2>Log Exercises for {{ view_date|date:"F d, Y" }}</h2>

    <!-- Form to add a single exercise log -->
    <form method="POST" action="{% url 'workouts:log_workout_date' date_str=view_date_str %}" id="add-exercise-form" class="mb-4 p-3 border rounded">
        {% csrf_token %}
        <input type="hidden" name="action" value="add_item">
        <input type="hidden" name="date" value="{{ view_date_str }}"> {# Context date #}

        <h4 class="mb-3">Add Exercise</h4>
        <div class="row g-3 align-items-end mb-3">
            {# Exercise dropdown #}
            <div class="col-md-4">
                <label for="exercise" class="form-label">Exercise *</label>
                <select name="exercise" id="exercise" class="form-select" required>
                    <option value="">-- Select Exercise --</option>
                    {% for ex in available_exercises %}
                    <option value="{{ ex.id }}">{{ ex.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {# Sets input #}
            <div class="col-md-1">
                <label for="sets" class="form-label">Sets</label>
                <input type="number" name="sets" id="sets" class="form-control" min="0">
            </div>
            {# Reps input #}
            <div class="col-md-1">
                <label for="reps" class="form-label">Reps</label>
                <input type="number" name="reps" id="reps" class="form-control" min="0">
            </div>
            {# Weight input #}
            <div class="col-md-2">
                <label for="weight" class="form-label">Weight (kg)</label>
                <input type="number" step="0.01" name="weight" id="weight" class="form-control" min="0">
            </div>
             {# Add button #}
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Add to {{ view_date|date:"M d" }} Workout</button>
            </div>
        </div>
        <small class="text-muted">* Required field</small>
    </form>

    <hr>

    <!-- Display current "Cart" items for the specific date -->
    <h3>Workout Items for {{ view_date|date:"F d, Y" }} (Not Saved Yet)</h3>
    {% if cart_items %}
        <ul class="list-group mb-3">
            {% for item in cart_items %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        <strong>{{ item.exercise_name }}</strong>
                        {% if item.sets and item.reps %} - {{ item.sets }}x{{ item.reps }}{% endif %}
                        {% if item.weight %} @ {{ item.weight }}kg{% endif %}
                        {# Add remove button later? #}
                    </span>
                </li>
            {% endfor %}
        </ul>
         <!-- Form/Button to Save the workout for the specific date -->
        <form method="POST" action="{% url 'workouts:save_workout' %}">
             {% csrf_token %}
             <input type="hidden" name="date_to_save" value="{{ view_date_str }}"> {# Ensure this is passed #}
             {# Optional: Add session notes field #}
             {#
             <div class="mb-3">
                <label for="session_notes" class="form-label">Session Notes (Optional)</label>
                <textarea class="form-control" id="session_notes" name="session_notes" rows="2"></textarea>
             </div>
             #}
             <button type="submit" class="btn btn-success">Save {{ view_date|date:"M d" }} Workout Session</button>
        </form>
    {% else %}
        <p>No exercises added to this workout yet.</p>
    {% endif %}

</div>
{% endblock %}